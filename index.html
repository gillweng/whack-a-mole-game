const holes = document.querySelectorAll('.hole');
const moles = document.querySelectorAll('.mole');
const scoreDisplay = document.getElementById('score');
const timeDisplay = document.getElementById('time');
const startBtn = document.getElementById('start-btn');

let score = 0;
let timeLeft = 30;
let gameActive = false;
let gameTimer;
let countdownTimer;
let moleTimer;

// 添加音頻物件
const backgroundMusic = new Audio('background-music.mp3');
const hitSound = new Audio('hit-sound.mp3');

// 設置背景音樂循環播放
backgroundMusic.loop = true;

// 確保音頻上下文在用戶互動後啟用
function ensureAudioContext(audioElement) {
    return new Promise((resolve) => {
        if (audioElement.readyState >= 2) {
            resolve();
        } else {
            audioElement.addEventListener('loadeddata', resolve, { once: true });
        }
    });
}

// 重置音頻物件以確保重複播放
async function resetAndPlayAudio(audioElement) {
    try {
        audioElement.pause();
        audioElement.currentTime = 0; // 重置到開始
        await ensureAudioContext(audioElement); // 確保音頻上下文準備好
        await audioElement.play(); // 播放音頻
    } resetAndPlayAudio(audioElement); // 確保音頻上下文準備好
        await audioElement.play(); // 播放音頻
    } catch (error) {
        console.log('音頻重置或播放錯誤:', error);
    }
}

function randomHole() {
    const idx = Math.floor(Math.random() * holes.length);
    return holes[idx];
}

function showMole() {
    if (!gameActive) return;

    const hole = randomHole();
    const mole = hole.querySelector('.mole');

    mole.classList.remove('hidden');

    moleTimer = setTimeout(() => {
        mole.classList.add('hidden');
        if (gameActive) showMole();
    }, 1000);
}

moles.forEach(mole => {
    mole.addEventListener('click', async () => {
        if (!mole.classList.contains('hidden') && gameActive) {
            score++;
            scoreDisplay.textContent = score;
            mole.classList.add('hidden');
            // 重置並播放擊中聲音
            await resetAndPlayAudio(hitSound);
        }
    });
});

function startCountdown() {
    countdownTimer = setInterval(() => {
        timeLeft--;
        timeDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
            endGame();
        }
    }, 1000);
}

async function startGame() {
    try {
        await ensureAudioContext(backgroundMusic);
        backgroundMusic.play().catch(error => console.log('背景音樂播放失敗:', error));
        showMole();
        startCountdown();
    } catch (error) {
        console.log('音頻加載或播放錯誤:', error);
    }
}

function endGame() {
    gameActive = false;
    clearInterval(countdownTimer);
    clearTimeout(moleTimer);
    backgroundMusic.pause(); // 停止背景音樂
    backgroundMusic.currentTime = 0; // 重置背景音樂
    startBtn.textContent = '重新開始';
    alert(`遊戲結束！你的得分是：${score}`);
}

startBtn.addEventListener('click', () => {
    if (gameActive) return;

    gameActive = true;
    score = 0;
    timeLeft = 30;
    scoreDisplay.textContent = score;
    timeDisplay.textContent = timeLeft;
    startBtn.textContent = '遊戲進行中...';

    startGame();
});
